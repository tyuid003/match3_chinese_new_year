<!DOCTYPE html>
<html lang="th">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin - Match3 ตรุษจีน</title>
	<style>
		*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Arial}
		body{background:linear-gradient(135deg,#c30000 0%,#8b0000 100%);color:#fff;min-height:100vh;padding:24px}
		.wrap{max-width:1200px;margin:0 auto}
		h1{color:#ffd700;margin-bottom:16px}
		.card{background:rgba(0,0,0,0.25);border:1px solid rgba(255,215,0,0.25);border-radius:12px;padding:16px;margin-bottom:16px}
		.row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
		label{font-size:12px;color:#ffd700}
		input{width:100%;padding:10px 12px;border-radius:8px;border:none}
		.btn{background:linear-gradient(90deg,#ff0000,#ff7b00);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
		.btn-secondary{background:#fff;color:#c30000}
		.btn-danger{background:#8b0000}
		.actions{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
		.link-box{display:flex;gap:8px;align-items:center;margin-top:10px}
		.link-box input{flex:1}
		table{width:100%;border-collapse:collapse}
		th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;font-size:14px}
		th{color:#ffd700}
		.table-actions{display:flex;gap:6px;flex-wrap:wrap}
		@media (max-width: 900px){
			.row{grid-template-columns:1fr 1fr}
		}
		@media (max-width: 600px){
			.row{grid-template-columns:1fr}
		}
	</style>
</head>
<body>
	<div class="wrap">
		<h1>แอดมิน - จัดการผู้เล่น</h1>

		<div class="card">
			<h3>สร้างผู้เล่นใหม่</h3>
			<div class="row" style="margin-top:12px">
				<div>
					<label>USER_ID</label>
					<input id="userId" placeholder="เช่น U0001" />
				</div>
				<div>
					<label>ชื่อ</label>
					<input id="firstName" placeholder="ชื่อ" />
				</div>
				<div>
					<label>นามสกุล</label>
					<input id="lastName" placeholder="นามสกุล" />
				</div>
				<div>
					<label>เบอร์โทร</label>
					<input id="phone" placeholder="0xx-xxx-xxxx" />
				</div>
			</div>
			<div class="actions">
				<button class="btn" id="createBtn">บันทึกผู้เล่น</button>
				<button class="btn-secondary btn" id="refreshBtn">รีเฟรชตาราง</button>
			</div>
			<div class="link-box">
				<input id="playLink" readonly placeholder="ลิงก์สำหรับให้ลูกค้าเล่นเกม" />
				<button class="btn" id="copyBtn">คัดลอกลิงก์</button>
			</div>
		</div>

		<div class="card">
			<h3>รายชื่อผู้เล่น</h3>
			<table>
				<thead>
					<tr>
						<th>USER_ID</th>
						<th>ชื่อ</th>
						<th>นามสกุล</th>
						<th>เบอร์โทร</th>
						<th>สกอร์</th>
						<th>finish</th>
						<th>claimed</th>
						<th>จัดการ</th>
					</tr>
				</thead>
				<tbody id="userTable"></tbody>
			</table>
		</div>
	</div>

	<script>
		const userIdEl = document.getElementById('userId');
		const firstNameEl = document.getElementById('firstName');
		const lastNameEl = document.getElementById('lastName');
		const phoneEl = document.getElementById('phone');
		const playLinkEl = document.getElementById('playLink');
		const userTable = document.getElementById('userTable');

		const baseUrl = window.location.origin;

		function updateLink(){
			const userId = (userIdEl.value || '').trim();
			playLinkEl.value = userId ? `${baseUrl}/index.html?u=${encodeURIComponent(userId)}` : '';
		}

		userIdEl.addEventListener('input', updateLink);

		document.getElementById('copyBtn').addEventListener('click', async ()=>{
			if(!playLinkEl.value) return;
			await navigator.clipboard.writeText(playLinkEl.value);
		});

		document.getElementById('createBtn').addEventListener('click', async ()=>{
			const payload = {
				user_id: (userIdEl.value || '').trim(),
				first_name: (firstNameEl.value || '').trim(),
				last_name: (lastNameEl.value || '').trim(),
				phone: (phoneEl.value || '').trim()
			};
			if(!payload.user_id || !payload.first_name || !payload.last_name || !payload.phone) return;

			await fetch('/api/admin/users', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});

			userIdEl.value=''; firstNameEl.value=''; lastNameEl.value=''; phoneEl.value='';
			updateLink();
			loadUsers();
		});

		document.getElementById('refreshBtn').addEventListener('click', loadUsers);

		async function loadUsers(){
			const res = await fetch('/api/admin/users');
			const data = await res.json();
			userTable.innerHTML = '';
			(data.items || []).forEach(row => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${row.user_id}</td>
					<td><input value="${row.first_name}" data-field="first_name" /></td>
					<td><input value="${row.last_name}" data-field="last_name" /></td>
					<td><input value="${row.phone}" data-field="phone" /></td>
					<td><input value="${row.score}" data-field="score" /></td>
					<td>${row.finish ? 'true' : 'false'}</td>
					<td>${row.claimed ? 'true' : 'false'}</td>
					<td class="table-actions">
						<button class="btn" data-action="save">บันทึก</button>
						<button class="btn-danger btn" data-action="delete">ลบ</button>
					</td>
				`;

				tr.querySelector('[data-action="save"]').addEventListener('click', async ()=>{
					const inputs = tr.querySelectorAll('input');
					const payload = { user_id: row.user_id };
					inputs.forEach(i => payload[i.dataset.field] = i.value);
					await fetch('/api/admin/user', {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					loadUsers();
				});

				tr.querySelector('[data-action="delete"]').addEventListener('click', async ()=>{
					await fetch('/api/admin/user', {
						method: 'DELETE',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ user_id: row.user_id })
					});
					loadUsers();
				});

				userTable.appendChild(tr);
			});
		}

		loadUsers();
	</script>
</body>
</html>
