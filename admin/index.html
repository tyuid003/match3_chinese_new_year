<!DOCTYPE html>
<html lang="th">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin - Match3 ตรุษจีน</title>
	<style>
		*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Arial}
		body{background:linear-gradient(135deg,#f5f5f5 0%,#ffffff 100%);color:#fff;min-height:100vh;padding:24px}
		.wrap{max-width:1200px;margin:0 auto}
		h1{color:#000000;margin-bottom:16px}
		.card{background:rgba(175, 175, 175, 0.25);border:1px solid rgba(138, 138, 138, 0.25);border-radius:12px;padding:16px;margin-bottom:16px}
		.row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
		label{font-size:12px;color:#000000}
		input{width:100%;padding:10px 10px;border-radius:8px;border:none}
		.btn{background:linear-gradient(90deg,#ff0000,#ff7b00);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
		.btn-secondary{background:#fff;color:#c30000}
		.btn-danger{background:#8b0000}
		.actions{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
		table{width:100%;border-collapse:collapse}
		th,td{padding:5px;border-bottom:1px solid rgba(0, 0, 0, 0.1);text-align:left;font-size:14px;    color: #000;}
		th{color:#000000}
		.table-actions{display:flex;gap:6px;flex-wrap:wrap}
        h3{color:#000000;margin-bottom:8px}
		.status-icon{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;font-weight:800;font-size:12px}
		.status-yes{background:#16a34a;color:#fff}
		.status-no{background:#e5e7eb;color:#6b7280}
		.icon-btn{border:none;background:#16a34a;color:#fff;font-weight:800;border-radius:50%;width:22px;height:22px;cursor:pointer}
		.finish-toggle{cursor:pointer;transition:transform 0.2s}
		.finish-toggle:hover{transform:scale(1.1)}
		.modal input{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
		.modal label{display:block;font-size:12px;color:#6b7280;margin-bottom:4px;margin-top:8px}
		.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:200}
		.overlay.show{display:flex}
		.modal{background:#fff;color:#111;padding:20px;border-radius:12px;min-width:320px;max-width:520px;width:90%}
		.modal h3{color:#111;margin:0 0 12px 0}
		.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px;font-size:14px}
		.modal-item span{display:block;font-size:11px;color:#6b7280;margin-bottom:4px}
		.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
		.mono{font-family:ui-monospace,Consolas,monospace;font-size:13px}
		
		/* Toast notification */
		.toast{position:fixed;bottom:20px;right:20px;background:#15803d;color:#fff;padding:12px 16px;border-radius:8px;font-size:14px;animation:slideIn 0.3s ease-out;z-index:1000;max-width:300px}
		@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
		
		.modal-confirm{background:#fff;color:#111;padding:24px;border-radius:12px;min-width:360px;max-width:440px;width:90%;text-align:center}
		.modal-confirm h3{color:#111;margin:0 0 12px 0;font-size:18px}
		.modal-confirm p{color:#666;margin-bottom:20px;line-height:1.5}
		.modal-confirm-actions{display:flex;gap:12px;justify-content:center;margin-top:24px}
		.modal-confirm-actions .btn{padding:10px 24px}
		
		@media (max-width: 900px){
			.row{grid-template-columns:1fr 1fr}
		}
		@media (max-width: 600px){
			.row{grid-template-columns:1fr}
		}
	</style>
</head>
<body>
	<div class="wrap">
		<h1>แอดมิน - จัดการผู้เล่น</h1>

		<div class="card">
			<h3>สร้างผู้เล่นใหม่</h3>
			<div id="statusMsg" style="margin-top:8px;color:#b91c1c;font-size:12px"></div>
			<div class="row" style="margin-top:12px">
				<div>
					<label>USER_ID</label>
					<input id="userId" placeholder="เช่น U0001" />
				</div>
				<div>
					<label>ชื่อ</label>
					<input id="firstName" placeholder="ชื่อ" />
				</div>
				<div>
					<label>นามสกุล</label>
					<input id="lastName" placeholder="นามสกุล" />
				</div>
				<div>
					<label>เบอร์โทร</label>
					<input id="phone" placeholder="0xx-xxx-xxxx" />
				</div>
			</div>
			<div class="actions">
				<button class="btn" id="createBtn">บันทึก</button>
				<button class="btn-secondary btn" id="refreshBtn">รีเฟรช</button>
			</div>
		</div>

		<div class="card">
			<h3>รายชื่อผู้เล่น</h3>
			<table>
				<thead>
					<tr>
						<th>USER_ID</th>
						<th>ชื่อ</th>
						<th>นามสกุล</th>
						<th>เบอร์โทร</th>
						<th>สกอร์</th>
						<th>จบเกม</th>
						<th>รับของ</th>
						<th>จัดการ</th>
					</tr>
				</thead>
				<tbody id="userTable"></tbody>
			</table>
		</div>

		<div class="overlay" id="detailOverlay">
			<div class="modal">
				<h3>ข้อมูลผู้รับรางวัล / แก้ไขที่อยู่</h3>
				<input type="hidden" id="editUserId" />
				<div style="margin-bottom:12px">
					<label>USER_ID</label>
					<div class="mono" id="detailUserId" style="padding:8px;background:#f3f4f6;border-radius:6px"></div>
				</div>
				<div class="modal-grid">
					<div class="modal-item"><label>ชื่อ</label><div id="detailFirstName" style="padding:8px;background:#f3f4f6;border-radius:6px"></div></div>
					<div class="modal-item"><label>นามสกุล</label><div id="detailLastName" style="padding:8px;background:#f3f4f6;border-radius:6px"></div></div>
					<div class="modal-item" style="grid-column:1/-1"><label>เบอร์โทร</label><div id="detailPhone" style="padding:8px;background:#f3f4f6;border-radius:6px"></div></div>
					<div class="modal-item" style="grid-column:1/-1"><label>ที่อยู่</label><input id="editAddress" placeholder="บ้านเลขที่ ซอย ถนน" /></div>
					<div class="modal-item"><label>แขวง/ตำบล</label><input id="editSubdistrict" placeholder="แขวง/ตำบล" /></div>
					<div class="modal-item"><label>เขต/อำเภอ</label><input id="editDistrict" placeholder="เขต/อำเภอ" /></div>
					<div class="modal-item"><label>จังหวัด</label><input id="editProvince" placeholder="จังหวัด" /></div>
					<div class="modal-item"><label>รหัสไปรษณีย์</label><input id="editPostal" placeholder="รหัสไปรษณีย์" /></div>
				</div>
				<div class="modal-actions">
					<button class="btn" id="saveAddressBtn">บันทึกที่อยู่</button>
					<button class="btn-secondary btn" id="copyDetailBtn">คัดลอกข้อมูล</button>
					<button class="btn-secondary btn" id="closeDetailBtn">ปิด</button>
				</div>
			</div>
		</div>

		<div class="overlay" id="confirmDeleteOverlay">
			<div class="modal-confirm">
				<h3>⚠️ ยืนยันการลบ</h3>
				<p>คุณแน่ใจว่าต้องการลบผู้เล่น <strong id="confirmDeleteUserId"></strong> หรือไม่?</p>
				<div class="modal-confirm-actions">
					<button class="btn-secondary btn" id="cancelDeleteBtn">ยกเลิก</button>
					<button class="btn-danger btn" id="confirmDeleteBtn">ลบทันที</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const userIdEl = document.getElementById('userId');
		const firstNameEl = document.getElementById('firstName');
		const lastNameEl = document.getElementById('lastName');
		const phoneEl = document.getElementById('phone');
		const userTable = document.getElementById('userTable');
		const statusMsg = document.getElementById('statusMsg');
		const detailOverlay = document.getElementById('detailOverlay');
		const confirmDeleteOverlay = document.getElementById('confirmDeleteOverlay');
		const detailUserId = document.getElementById('detailUserId');
		const detailFirstName = document.getElementById('detailFirstName');
		const detailLastName = document.getElementById('detailLastName');
		const detailPhone = document.getElementById('detailPhone');
		const editUserId = document.getElementById('editUserId');
		const editAddress = document.getElementById('editAddress');
		const editSubdistrict = document.getElementById('editSubdistrict');
		const editDistrict = document.getElementById('editDistrict');
		const editProvince = document.getElementById('editProvince');
		const editPostal = document.getElementById('editPostal');
		const confirmDeleteUserId = document.getElementById('confirmDeleteUserId');

		const baseUrl = window.location.origin;
		let pendingDeleteUserId = null;

		function setStatus(message, isError = true){
			statusMsg.textContent = message || '';
			statusMsg.style.color = isError ? '#b91c1c' : '#15803d';
		}

		// Show toast notification
		function showToast(message, duration = 2000){
			const toast = document.createElement('div');
			toast.className = 'toast';
			toast.textContent = message;
			document.body.appendChild(toast);
			setTimeout(() => {
				toast.style.opacity = '0';
				setTimeout(() => toast.remove(), 300);
			}, duration);
		}

		document.getElementById('createBtn').addEventListener('click', async ()=>{
			const payload = {
				user_id: (userIdEl.value || '').trim(),
				first_name: (firstNameEl.value || '').trim(),
				last_name: (lastNameEl.value || '').trim(),
				phone: (phoneEl.value || '').trim()
			};
			if(!payload.user_id || !payload.first_name || !payload.last_name || !payload.phone) return;
			setStatus('');
			const res = await fetch('/api/admin/users', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if(!res.ok){
				const data = await res.json().catch(()=>({}));
				setStatus(data.error || 'บันทึกไม่สำเร็จ');
				return;
			}
			setStatus('บันทึกสำเร็จ', false);

			userIdEl.value=''; firstNameEl.value=''; lastNameEl.value=''; phoneEl.value='';
			loadUsers();
		});

		document.getElementById('refreshBtn').addEventListener('click', loadUsers);

		async function loadUsers(){
			const res = await fetch('/api/admin/users');
			const data = await res.json();
			userTable.innerHTML = '';
			(data.items || []).forEach(row => {
				const finishIcon = row.finish 
					? '<button class="icon-btn finish-toggle" data-action="toggle-finish" data-current="true" title="คลิกเพื่อลบสถานะจบเกม">✔</button>' 
					: '<button class="icon-btn" data-action="toggle-finish" data-current="false" title="คลิกเพื่อเปลี่ยนเป็นจบเกม" style="background:#6b7280">-</button>';
				const claimedIcon = row.claimed ? '<button class="icon-btn" data-action="claimed" title="ดูข้อมูล/แก้ไขที่อยู่">✔</button>' : '<span class="status-icon status-no">-</span>';
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${row.user_id}</td>
					<td><input value="${row.first_name}" data-field="first_name" /></td>
					<td><input value="${row.last_name}" data-field="last_name" /></td>
					<td><input value="${row.phone}" data-field="phone" /></td>
					<td><input value="${row.score}" data-field="score" /></td>
					<td>${finishIcon}</td>
					<td>${claimedIcon}</td>
					<td class="table-actions">
						<button class="btn" data-action="save">บันทึก</button>
						<button class="btn-secondary btn" data-action="copy-link">คัดลอกลิงก์</button>
						<button class="btn-danger btn" data-action="delete">ลบ</button>
					</td>
				`;

				tr.querySelector('[data-action="save"]').addEventListener('click', async ()=>{
					const inputs = tr.querySelectorAll('input');
					const payload = { user_id: row.user_id };
					inputs.forEach(i => payload[i.dataset.field] = i.value);
					await fetch('/api/admin/user', {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					showToast('✔️ บันทึกสำเร็จ');
					loadUsers();
				});

				tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
					pendingDeleteUserId = row.user_id;
					confirmDeleteUserId.textContent = row.user_id;
					confirmDeleteOverlay.classList.add('show');
				});

				tr.querySelector('[data-action="copy-link"]').addEventListener('click', async ()=>{
					const link = `${baseUrl}/index.html?u=${encodeURIComponent(row.user_id)}`;
					await navigator.clipboard.writeText(link);
					showToast('✔️ คัดลอกลิงก์แล้ว');
				});

				const toggleFinishBtn = tr.querySelector('[data-action="toggle-finish"]');
				if(toggleFinishBtn){
					toggleFinishBtn.addEventListener('click', async ()=>{
						const currentStatus = toggleFinishBtn.dataset.current === 'true';
						const newStatus = !currentStatus;
						const message = newStatus ? 'ต้องการเปลี่ยนสถานะเป็น "จบเกม" หรือไม่?' : 'ต้องการลบสถานะ "จบเกม" หรือไม่?';
						if(!confirm(message)) return;
						await fetch('/api/admin/user', {
							method: 'PUT',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ user_id: row.user_id, finish: newStatus })
						});
						showToast(newStatus ? '✔️ ตั้งสถานะจบเกมแล้ว' : '✔️ ลบสถานะจบเกมแล้ว');
						loadUsers();
					});
				}

				const claimedBtn = tr.querySelector('[data-action="claimed"]');
				if(claimedBtn){
					claimedBtn.addEventListener('click', ()=>{
						detailUserId.textContent = row.user_id;
						detailFirstName.textContent = row.first_name || '-';
						detailLastName.textContent = row.last_name || '-';
						detailPhone.textContent = row.phone || '-';
						editUserId.value = row.user_id;
						editAddress.value = row.address || '';
						editSubdistrict.value = row.subdistrict || '';
						editDistrict.value = row.district || '';
						editProvince.value = row.province || '';
						editPostal.value = row.postal_code || '';
						detailOverlay.classList.add('show');
					});
				}

				userTable.appendChild(tr);
			});
		}

		document.getElementById('closeDetailBtn').addEventListener('click', ()=>{
			detailOverlay.classList.remove('show');
		});

		document.getElementById('saveAddressBtn').addEventListener('click', async ()=>{
			const userId = editUserId.value.trim();
			if(!userId) return;
			await fetch('/api/admin/user', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					user_id: userId,
					address: editAddress.value.trim(),
					subdistrict: editSubdistrict.value.trim(),
					district: editDistrict.value.trim(),
					province: editProvince.value.trim(),
					postal_code: editPostal.value.trim()
				})
			});
			showToast('✔️ บันทึกที่อยู่สำเร็จ');
			detailOverlay.classList.remove('show');
			loadUsers();
		});

		document.getElementById('copyDetailBtn').addEventListener('click', async ()=>{
			const fullName = `${detailFirstName.textContent} ${detailLastName.textContent}`.trim();
			const fullAddress = [editAddress.value, editSubdistrict.value, editDistrict.value, editProvince.value, editPostal.value]
				.filter(Boolean)
				.join(' ');
			const text = `USER_ID: ${detailUserId.textContent}\nชื่อ-นามสกุล: ${fullName}\nเบอร์โทร: ${detailPhone.textContent}\nที่อยู่: ${fullAddress || '-'}`;
			await navigator.clipboard.writeText(text);
			showToast('✔️ คัดลอกข้อมูลแล้ว');
		});

		document.getElementById('cancelDeleteBtn').addEventListener('click', ()=>{
			confirmDeleteOverlay.classList.remove('show');
			pendingDeleteUserId = null;
		});

		document.getElementById('confirmDeleteBtn').addEventListener('click', async ()=>{
			if(!pendingDeleteUserId) return;
			await fetch('/api/admin/user', {
				method: 'DELETE',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ user_id: pendingDeleteUserId })
			});
			confirmDeleteOverlay.classList.remove('show');
			showToast('✔️ ลบผู้เล่นแล้ว');
			pendingDeleteUserId = null;
			loadUsers();
		});

		loadUsers();
	</script>
</body>
</html>
